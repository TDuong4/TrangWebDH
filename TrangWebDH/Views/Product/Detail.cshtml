@model Product
@{
    ViewData["Title"] = Model.Name;
}

<h1>@Model.Name</h1>

<!-- ẢNH SẢN PHẨM -->
<div class="mb-3">
    @foreach (var img in Model.Images)
    {
        <img src="@img.ImagePath" class="product-img img-thumbnail me-2" style="max-width: 200px;" alt="@Model.Name" />
    }
</div>

<!-- THÔNG TIN -->
<p>@Model.Description</p>
<p>
    <strong>Giá:</strong> @Model.Price.ToString("N0") ₫ |
    <strong>Số lượng:</strong> @(Model.Quantity ?? 0) |
    <strong>Kích cỡ/Trọng lượng:</strong> @Model.SizeOrWeight
</p>

<!-- THÊM VÀO SAU PHẦN GIÁ -->
<div class="mt-3">
    <form asp-controller="Cart" asp-action="Add" method="post" class="d-inline">
        <input type="hidden" name="productId" value="@Model.Id" />
        <div class="input-group mb-3" style="max-width: 200px;">
            <button type="button" class="btn btn-outline-secondary" onclick="this.nextElementSibling.stepDown()">-</button>
            <input type="number" name="quantity" value="1" min="1" max="100" class="form-control text-center">
            <button type="button" class="btn btn-outline-secondary" onclick="this.previousElementSibling.stepUp()">+</button>
        </div>
        <button type="submit" class="btn btn-primary btn-lg me-2">
            <i class="bi bi-cart-plus"></i> Thêm vào giỏ hàng
        </button>
    </form>
</div>

<!-- ĐÁNH GIÁ -->
<h2>Đánh giá (@Model.Reviews.Count)</h2>
@if (Model.Reviews.Any())
{
    @foreach (var r in Model.Reviews)
    {
        <div class="border p-3 mb-2 rounded bg-light">
            <strong>@(r.Customer?.FullName ?? "Khách")</strong>
            <span class="text-warning">★ @r.Rating</span>
            <p class="mb-1">@r.Content</p> <!-- ĐÃ SỬA TỪ Comment → Content -->
            <small class="text-muted">@r.CreatedDate.ToString("dd/MM/yyyy HH:mm")</small>
        </div>
    }
}
else
{
    <p class="text-muted">Chưa có đánh giá nào.</p>
}

<!-- CHAT VỚI SHOP -->
<h2>Chat với Shop</h2>
<div id="chatBox" class="chat-box border p-3 mb-3" style="height: 300px; overflow-y: auto; background: #f9f9f9;">
    <!-- Tin nhắn sẽ load bằng AJAX -->
</div>

<div class="input-group">
    <input type="text" id="msg" class="form-control" placeholder="Nhập tin nhắn..." />
    <button class="btn btn-primary" onclick="sendMessage(@Model.Id)">Gửi</button>
</div>

<!-- SCRIPT CHAT -->
@section Scripts {
    <script>
        // Load tin nhắn khi mở trang
        loadChat(@Model.Id);

        function loadChat(productId) {
            $("#chatBox").load("/Product/Chat?productId=" + productId);
        }

        function sendMessage(productId) {
            var msg = $("#msg").val().trim();
            if (!msg) return;

            $.post("/Product/SendMessage", {
                productId: productId,
                message: msg
            })
            .done(function () {
                $("#msg").val("");
                loadChat(productId); // Reload chat
            })
            .fail(function () {
                alert("Gửi tin nhắn thất bại!");
            });
        }

        // Gửi bằng Enter
        $("#msg").on("keypress", function (e) {
            if (e.which === 13) {
                sendMessage(@Model.Id);
            }
        });
    </script>
}